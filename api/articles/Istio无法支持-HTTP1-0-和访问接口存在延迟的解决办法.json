{"title":"Istio 无法支持 HTTP1.0 和访问接口存在延迟的解决办法","uid":"8c86b39e74b792721702587f520ee80d","slug":"Istio无法支持-HTTP1-0-和访问接口存在延迟的解决办法","date":"2022-08-10T06:24:00.000Z","updated":"2022-08-11T08:06:48.627Z","comments":true,"path":"api/articles/Istio无法支持-HTTP1-0-和访问接口存在延迟的解决办法.json","keywords":"coding","cover":"http://www.designerspics.com/wp-content/uploads/2014/12/paper_plane_free_photo.jpg","content":"<h1 id=\"现象\"><a href=\"#现象\" class=\"headerlink\" title=\"现象\"></a>现象</h1><p><code>Rancher</code> 通过 <code>RKE</code> 部署了 <code>K8S</code> 集群后,启动了 <code>Istio</code>,由于一些项目使用的事 <code>HTTP/1.0</code>协议,访问出现问题. <code>Istio</code> 默认只支持 <code>HTTP/1.1</code> 以上协议版本，并不支持 <code>HTTP/1.0</code>。</p>\n<h1 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h1><p><code>Istio</code> 默认不支持 <code>HTTP1.0</code> 协议</p>\n<p><a href=\"https://istio.io/latest/docs/reference/commands/pilot-agent/\">Istio 配置参考</a></p>\n<p><img src=\"/images/pasted-1.png\" alt=\"upload successful\"></p>\n<h1 id=\"解决办法\"><a href=\"#解决办法\" class=\"headerlink\" title=\"解决办法\"></a>解决办法</h1><p>修改环境变量 <code>PILOT_HTTP10</code> 为 1,即可增加对 <code>HTTP1.0</code>的支持。</p>\n<h2 id=\"Rancher-部署的ISTIO\"><a href=\"#Rancher-部署的ISTIO\" class=\"headerlink\" title=\"Rancher 部署的ISTIO\"></a>Rancher 部署的ISTIO</h2><p><img src=\"/images/pasted-0.png\" alt=\"upload successful\"></p>\n<p>主要方式是修改 环境变量的值.<br>修改<code>Deployments</code> 中 <code>istiod</code> 资源的配置.增加环境变量 <code>PILOT_HTTP10</code>的值为 1 即可.</p>\n<p><img src=\"/images/pasted-2.png\" alt=\"upload successful\"></p>\n<h1 id=\"结果\"><a href=\"#结果\" class=\"headerlink\" title=\"结果\"></a>结果</h1><p>修改后 <code>HTTP1.0</code>已经可以支持了.但是出现了另外的问题.访问接口的时候出现了超时.所有接口访问速度都增加了大概 1 秒的样子.</p>\n<h1 id=\"解决-1-秒问题\"><a href=\"#解决-1-秒问题\" class=\"headerlink\" title=\"解决 1 秒问题\"></a>解决 1 秒问题</h1><p>查阅 <code>Envoy</code>的文档后发现,</p>\n<p><a href=\"https://www.envoyproxy.io/docs/envoy/v1.23.0/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html\">Envory相关配置地址</a></p>\n<p><img src=\"/images/pasted-3.png\" alt=\"upload successful\"></p>\n<p>修改改配置为 0 可以解决这个 1 秒延迟的问题.</p>\n<p><img src=\"/images/pasted-4.png\" alt=\"upload successful\"></p>\n<p>创建以下 <code>disable-close-timeout.yaml</code> 并配置到 kubernetes 集群 : <code>kubectl apply -f disable-close-timeout.yaml -n istio-system</code></p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: EnvoyFilter\nmetadata:\n  name: custom-protocol\n  namespace: istio-system\nspec:\n  configPatches:\n  - applyTo: NETWORK_FILTER\n    match:\n      listener:\n        filterChain:\n          filter:\n            name: envoy.filters.network.http_connection_manager\n    patch:\n      operation: MERGE\n      value:\n        name: envoy.filters.network.http_connection_manager\n        typed_config:\n          &#39;@type&#39;: type.googleapis.com&#x2F;envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\n          delayed_close_timeout: &quot;0&quot;\n</code></pre>","feature":true,"text":"现象Rancher 通过 RKE 部署了 K8S 集群后,启动了 Istio,由于一些项目使用的事 HTTP/1.0协议,访问出现问题. Istio 默认只支持 HTTP/1.1 以上协议版本，并不支持 HTTP/1.0。 原因Istio 默认不支持 HTTP1.0 协议 Ist...","link":"","photos":[],"count_time":{"symbolsCount":"1.1k","symbolsTime":"1 mins."},"categories":[{"name":"Kubernetes","slug":"Kubernetes","count":1,"path":"api/categories/Kubernetes.json"}],"tags":[{"name":"RKE","slug":"RKE","count":1,"path":"api/tags/RKE.json"},{"name":"Rancher","slug":"Rancher","count":1,"path":"api/tags/Rancher.json"},{"name":"Istio","slug":"Istio","count":1,"path":"api/tags/Istio.json"},{"name":"HTTP","slug":"HTTP","count":1,"path":"api/tags/HTTP.json"},{"name":"Kubernetes","slug":"Kubernetes","count":1,"path":"api/tags/Kubernetes.json"},{"name":"Envoy","slug":"Envoy","count":1,"path":"api/tags/Envoy.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%8E%B0%E8%B1%A1\"><span class=\"toc-text\">现象</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%8E%9F%E5%9B%A0\"><span class=\"toc-text\">原因</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95\"><span class=\"toc-text\">解决办法</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Rancher-%E9%83%A8%E7%BD%B2%E7%9A%84ISTIO\"><span class=\"toc-text\">Rancher 部署的ISTIO</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%BB%93%E6%9E%9C\"><span class=\"toc-text\">结果</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E8%A7%A3%E5%86%B3-1-%E7%A7%92%E9%97%AE%E9%A2%98\"><span class=\"toc-text\">解决 1 秒问题</span></a></li></ol>","author":{"name":"tusimo","slug":"tusimo","avatar":"https://avatars.githubusercontent.com/u/4344635?v=4","link":"https://github.com/tusimo","description":"Think like an artist, code like an artisan.","socials":{"github":"https://tusimo.github.io","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"php 容器化的几点建议","uid":"b14c7bb0c256981c822f52d59e144945","slug":"php-容器化的几点建议","date":"2022-08-10T10:15:00.000Z","updated":"2022-08-11T08:06:48.627Z","comments":true,"path":"api/articles/php-容器化的几点建议.json","keywords":"coding","cover":"https://images.pexels.com/photos/1044990/pexels-photo-1044990.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1","text":"镜像编译基础镜像编译github repo 基础镜像编译使用环境变量替换配置. FROM php:7.2-fpm-alpine # replace repositories RUN sed -i &#39;s&#x2F;dl-cdn.alpinelinux.org&#x2F;mi...","link":"","photos":[],"count_time":{"symbolsCount":"22k","symbolsTime":"20 mins."},"categories":[],"tags":[],"author":{"name":"tusimo","slug":"tusimo","avatar":"https://avatars.githubusercontent.com/u/4344635?v=4","link":"https://github.com/tusimo","description":"Think like an artist, code like an artisan.","socials":{"github":"https://tusimo.github.io","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{}}