{"title":"Istio 无法支持 HTTP1.0 和访问接口存在延迟的解决办法","uid":"8c86b39e74b792721702587f520ee80d","slug":"Istio无法支持-HTTP1-0-和访问接口存在延迟的解决办法","date":"2022-08-10T06:24:00.000Z","updated":"2024-09-23T10:05:21.954Z","comments":true,"path":"api/articles/Istio无法支持-HTTP1-0-和访问接口存在延迟的解决办法.json","keywords":"coding","cover":"http://www.designerspics.com/wp-content/uploads/2014/12/paper_plane_free_photo.jpg","content":"<h1 id=\"现象\"><a href=\"#现象\" class=\"headerlink\" title=\"现象\"></a>现象</h1><p><code>Rancher</code> 通过 <code>RKE</code> 部署了 <code>K8S</code> 集群后,启动了 <code>Istio</code>,由于一些项目使用的事 <code>HTTP/1.0</code>协议,访问出现问题. <code>Istio</code> 默认只支持 <code>HTTP/1.1</code> 以上协议版本，并不支持 <code>HTTP/1.0</code>。</p>\n<h1 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h1><p><code>Istio</code> 默认不支持 <code>HTTP1.0</code> 协议</p>\n<p><a href=\"https://istio.io/latest/docs/reference/commands/pilot-agent/\">Istio 配置参考</a></p>\n<p><img src=\"/images/pasted-1.png\" alt=\"upload successful\"></p>\n<h1 id=\"解决办法\"><a href=\"#解决办法\" class=\"headerlink\" title=\"解决办法\"></a>解决办法</h1><p>修改环境变量 <code>PILOT_HTTP10</code> 为 1,即可增加对 <code>HTTP1.0</code>的支持。</p>\n<h2 id=\"Rancher-部署的ISTIO\"><a href=\"#Rancher-部署的ISTIO\" class=\"headerlink\" title=\"Rancher 部署的ISTIO\"></a>Rancher 部署的ISTIO</h2><p><img src=\"/images/pasted-0.png\" alt=\"upload successful\"></p>\n<p>主要方式是修改 环境变量的值.<br>修改<code>Deployments</code> 中 <code>istiod</code> 资源的配置.增加环境变量 <code>PILOT_HTTP10</code>的值为 1 即可.</p>\n<p><img src=\"/images/pasted-2.png\" alt=\"upload successful\"></p>\n<h1 id=\"结果\"><a href=\"#结果\" class=\"headerlink\" title=\"结果\"></a>结果</h1><p>修改后 <code>HTTP1.0</code>已经可以支持了.但是出现了另外的问题.访问接口的时候出现了超时.所有接口访问速度都增加了大概 1 秒的样子.</p>\n<h1 id=\"解决-1-秒问题\"><a href=\"#解决-1-秒问题\" class=\"headerlink\" title=\"解决 1 秒问题\"></a>解决 1 秒问题</h1><p>查阅 <code>Envoy</code>的文档后发现,</p>\n<p><a href=\"https://www.envoyproxy.io/docs/envoy/v1.23.0/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html\">Envory相关配置地址</a></p>\n<p><img src=\"/images/pasted-3.png\" alt=\"upload successful\"></p>\n<p>修改改配置为 0 可以解决这个 1 秒延迟的问题.</p>\n<p><img src=\"/images/pasted-4.png\" alt=\"upload successful\"></p>\n<p>创建以下 <code>disable-close-timeout.yaml</code> 并配置到 kubernetes 集群 : <code>kubectl apply -f disable-close-timeout.yaml -n istio-system</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.istio.io/v1alpha3</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">EnvoyFilter</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">custom-protocol</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">istio-system</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">configPatches:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">applyTo:</span> <span class=\"string\">NETWORK_FILTER</span></span><br><span class=\"line\">    <span class=\"attr\">match:</span></span><br><span class=\"line\">      <span class=\"attr\">listener:</span></span><br><span class=\"line\">        <span class=\"attr\">filterChain:</span></span><br><span class=\"line\">          <span class=\"attr\">filter:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">envoy.filters.network.http_connection_manager</span></span><br><span class=\"line\">    <span class=\"attr\">patch:</span></span><br><span class=\"line\">      <span class=\"attr\">operation:</span> <span class=\"string\">MERGE</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">envoy.filters.network.http_connection_manager</span></span><br><span class=\"line\">        <span class=\"attr\">typed_config:</span></span><br><span class=\"line\">          <span class=\"string\">&#x27;@type&#x27;</span><span class=\"string\">:</span> <span class=\"string\">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span></span><br><span class=\"line\">          <span class=\"attr\">delayed_close_timeout:</span> <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","text":"现象Rancher 通过 RKE 部署了 K8S 集群后,启动了 Istio,由于一些项目使用的事 HTTP/1.0协议,访问出现问题. Istio 默认只支持...","permalink":"/post/Istio无法支持-HTTP1-0-和访问接口存在延迟的解决办法","photos":[],"count_time":{"symbolsCount":"1.2k","symbolsTime":"1 mins."},"categories":[{"name":"Kubernetes","slug":"Kubernetes","count":1,"path":"api/categories/Kubernetes.json"}],"tags":[{"name":"RKE","slug":"RKE","count":1,"path":"api/tags/RKE.json"},{"name":"Rancher","slug":"Rancher","count":1,"path":"api/tags/Rancher.json"},{"name":"Istio","slug":"Istio","count":1,"path":"api/tags/Istio.json"},{"name":"HTTP","slug":"HTTP","count":1,"path":"api/tags/HTTP.json"},{"name":"Kubernetes","slug":"Kubernetes","count":1,"path":"api/tags/Kubernetes.json"},{"name":"Envoy","slug":"Envoy","count":1,"path":"api/tags/Envoy.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%8E%B0%E8%B1%A1\"><span class=\"toc-text\">现象</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%8E%9F%E5%9B%A0\"><span class=\"toc-text\">原因</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95\"><span class=\"toc-text\">解决办法</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Rancher-%E9%83%A8%E7%BD%B2%E7%9A%84ISTIO\"><span class=\"toc-text\">Rancher 部署的ISTIO</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%BB%93%E6%9E%9C\"><span class=\"toc-text\">结果</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E8%A7%A3%E5%86%B3-1-%E7%A7%92%E9%97%AE%E9%A2%98\"><span class=\"toc-text\">解决 1 秒问题</span></a></li></ol>","author":{"name":"tusimo","slug":"tusimo","avatar":"https://avatars.githubusercontent.com/u/4344635?v=4","link":"https://github.com/tusimo","description":"Think like an artist, code like an artisan.","socials":{"github":"https://tusimo.github.io","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"php 容器化的几点建议","uid":"b14c7bb0c256981c822f52d59e144945","slug":"php-容器化的几点建议","date":"2022-08-10T10:15:00.000Z","updated":"2024-09-23T10:05:21.955Z","comments":true,"path":"api/articles/php-容器化的几点建议.json","keywords":"coding","cover":"https://images.pexels.com/photos/1044990/pexels-photo-1044990.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1","text":"镜像编译基础镜像编译github repo 基础镜像编译使用环境变量替换配置. 1234567891011121314151617181920212223242...","permalink":"/post/php-容器化的几点建议","photos":[],"count_time":{"symbolsCount":"21k","symbolsTime":"19 mins."},"categories":[{"name":"kubernetes","slug":"kubernetes","count":2,"path":"api/categories/kubernetes.json"},{"name":"php","slug":"kubernetes/php","count":1,"path":"api/categories/kubernetes/php.json"}],"tags":[{"name":"php","slug":"php","count":1,"path":"api/tags/php.json"},{"name":"kubernetes","slug":"kubernetes","count":2,"path":"api/tags/kubernetes.json"},{"name":"nginx","slug":"nginx","count":1,"path":"api/tags/nginx.json"},{"name":"docker","slug":"docker","count":1,"path":"api/tags/docker.json"}],"author":{"name":"tusimo","slug":"tusimo","avatar":"https://avatars.githubusercontent.com/u/4344635?v=4","link":"https://github.com/tusimo","description":"Think like an artist, code like an artisan.","socials":{"github":"https://tusimo.github.io","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"","uid":"f73a8e23e6f6f669cf99c7dba8fa0722","slug":"hello-world","date":"2022-08-08T13:35:00.000Z","updated":"2024-09-23T10:05:21.954Z","comments":true,"path":"api/articles/hello-world.json","keywords":"coding","cover":null,"text":"Welcome to Hexo! This is your very first post. Check documentation for more info...","permalink":"/post/hello-world","photos":[],"count_time":{"symbolsCount":444,"symbolsTime":"1 mins."},"categories":[],"tags":[],"author":{"name":"tusimo","slug":"blog-author","avatar":"https://tusimo.github.io/images/logo.png","link":"/","description":"show your the code","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}