{"title":"腾讯云 redis 迁移AWS的若干问题","uid":"5787a32e0acc329c90bb7d6138b83d3a","slug":"腾讯云-redis-迁移AWS的若干问题","date":"2022-08-22T07:09:00.000Z","updated":"2022-10-21T11:13:16.035Z","comments":true,"path":"api/articles/腾讯云-redis-迁移AWS的若干问题.json","keywords":"coding","cover":null,"content":"<h1 id=\"redis-迁移\"><a href=\"#redis-迁移\" class=\"headerlink\" title=\"redis 迁移\"></a>redis 迁移</h1><h2 id=\"全量迁移\"><a href=\"#全量迁移\" class=\"headerlink\" title=\"全量迁移\"></a>全量迁移</h2><p>  全量迁移比较简单,可以采用以下两种方式进行迁移.</p>\n<p>  1 rdb 导入导出</p>\n<pre><code>2 scan keys 进行同步\n</code></pre>\n<p>  以上方式可以通过 <a href=\"https://github.com/alibaba/RedisShake\"><code>redis-shake</code></a>实现.<br>  使用比较简单,可以参考官方文档进行配置.</p>\n<h2 id=\"增量迁移\"><a href=\"#增量迁移\" class=\"headerlink\" title=\"增量迁移\"></a>增量迁移</h2><p>  增量迁移可以通过以下方式进行</p>\n<p>  1 通过<code>PSYNC</code>进行主从同步</p>\n<p>  2 通过 redis 的 pub&#x2F;sub 监听所有 <code>keys</code>的变化进行修改增量数据<br>    <code>notify-keyspace-events</code> 可以开启 键值变化通知.通知通过 pub&#x2F;sub 输出.<br>    该方法需要开启配置 <code>notify-keyspace-events</code>的值为<code>KEA</code><br>    可以使用 <code>redis-cli</code>工具登录控制台并使用命令<code>config set notify-keyspace-events KEA</code>设置.<br>    云厂商也有后台可以修改这些配置来开启该功能.</p>\n<p>  <code>psync</code> 也可以通过 <code>redis-shake</code>实现增量同步.</p>\n<p>  但是云厂商的<code>redis</code>一般都是禁用了同步相关的 <code>SYNC</code> <code>PSYNC</code> 等命令.无法通过第一种方式进行同步.</p>\n<p>  第二种方式可以使用 <a href=\"https://developer.redis.com/riot/riot-redis/index.html\"><code>riot-redis</code></a> 进行同步</p>\n<h2 id=\"riot-redis-介绍\"><a href=\"#riot-redis-介绍\" class=\"headerlink\" title=\"riot-redis 介绍\"></a>riot-redis 介绍</h2><h3 id=\"安装-mac\"><a href=\"#安装-mac\" class=\"headerlink\" title=\"安装 - mac\"></a>安装 - mac</h3><pre class=\"line-numbers language-sh\" data-language=\"sh\"><code class=\"language-sh\">brew install redis-developer&#x2F;tap&#x2F;riot-redis</code></pre>\n\n<h3 id=\"命令介绍\"><a href=\"#命令介绍\" class=\"headerlink\" title=\"命令介绍\"></a>命令介绍</h3><h4 id=\"replicate\"><a href=\"#replicate\" class=\"headerlink\" title=\"replicate\"></a>replicate</h4><p><code>replicate</code> 使用 redis <code>dump</code>和<code>restore</code>命令进行同步</p>\n<p>参数:</p>\n<p><code>--scan-count</code> 表示每次扫描的 <code>key</code> 的数量,默认值: <code>1000</code><br><code>--scan-match</code> 表示要同步的<code>key</code>的匹配模式,默认是<code>*</code>,即同步所有的 <code>key</code><br><code>--scan-type</code> 表示扫描的值类型,默认值 全部类型<br><code>--reader-threads</code> 表示开启多少个读线程, 默认值: <code>1</code><br><code>--reader-batch</code> 表示单个线程 在一次<code>pipeline</code>里 <code>dump</code>的值数量 默认值:<code>50</code><br><code>--reader-queue</code> 是内部共享队列的最大大小. 默认值: <code>10000</code> ,该值最小要大于<code>--reader-threads</code>*<code>--reader-batch</code><br><code>--reader-pool</code> 表示读连接池的大小.可以小于<code>--reader-threads</code>.默认值:<code>8</code></p>\n<p><code>replicate-ds</code> 使用 对应的读写命令进行还原.</p>\n<p>比如读取到的是 <code>string</code>, 那么还原的时候就使用<code>set</code>命令还原.</p>\n<h3 id=\"命令示例\"><a href=\"#命令示例\" class=\"headerlink\" title=\"命令示例\"></a>命令示例</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">\n&#x2F;&#x2F;使用默认值全量同步\nriot-redis -h redis.database.svc.cluster.local -p 6379 -a test replicate -h redis2.database.svc.cluster.local -p 6379 -a test\n\n\n&#x2F;&#x2F;使用默认值全量同步并增量同步\nriot-redis -h redis.database.svc.cluster.local -p 6379 -a test replicate -h redis2.database.svc.cluster.local -p 6379 -a test --mode live\n\n\n&#x2F;&#x2F;仅使用增量同步\nriot-redis -h redis.database.svc.cluster.local -p 6379 -a test replicate -h redis2.database.svc.cluster.local -p 6379 -a test --mode liveonly\n\n&#x2F;&#x2F;使用自定义值全量同步并增量同步\nriot-redis -h redis.database.svc.cluster.local -p 6379 -a test replicate-ds -h redis2.database.svc.cluster.local -p 6379 -a test --reader-threads 4 --scan-count 2000 --reader-batch 200 --reader-queue 50000 --reader-pool 20 --mode live\n</code></pre>\n\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>如果命令运行执行出现问题.</p>\n<p>可以增加 <code>--info</code> 或者 <code>-d</code>输出详细信息调试.</p>\n<pre class=\"line-numbers language-sh\" data-language=\"sh\"><code class=\"language-sh\">riot-redis --info -h redis.database.svc.cluster.local -p 6379 -a test replicate-ds -h redis2.database.svc.cluster.local -p 6379 -a test --reader-threads 4 --scan-count 2000 --reader-batch 200 --reader-queue 50000 --reader-pool 20 --mode live\n\nriot-redis -d -h redis.database.svc.cluster.local -p 6379 -a test replicate-ds -h redis2.database.svc.cluster.local -p 6379 -a test --reader-threads 4 --scan-count 2000 --reader-batch 200 --reader-queue 50000 --reader-pool 20 --mode live</code></pre>\n\n\n<h3 id=\"连接-AWS-的-redis-报-Client-set-AUTH-but-no-password-is-set\"><a href=\"#连接-AWS-的-redis-报-Client-set-AUTH-but-no-password-is-set\" class=\"headerlink\" title=\"连接 AWS 的 redis 报 Client set AUTH, but no password is set.\"></a>连接 AWS 的 redis 报 <code>Client set AUTH, but no password is set</code>.</h3><p>  这个是由于<code>AWS</code>默认创建的<code>redis</code>没有设置密码,但是运维给了一个<code>on ~* +@all</code>的字符串说是密码.实际上这个是<code>AWS</code>的权限控制字符串.并不是密码.<br>  所以使用空密码就不报错了.</p>\n<h3 id=\"连接腾讯云-的-redis-报-NOAUTH-Authentication-required\"><a href=\"#连接腾讯云-的-redis-报-NOAUTH-Authentication-required\" class=\"headerlink\" title=\"连接腾讯云 的 redis 报  NOAUTH Authentication required.\"></a>连接腾讯云 的 redis 报 <code> NOAUTH Authentication required</code>.</h3><p>  1 首先确认 <code>redis</code> 的密码是否正确<br>  2 查看 <code>redis</code> 版本. 我在腾讯云上 使用 <code>redis</code> 4.0 版本的时候在密码正确的情况下,会报这个错误.升级到 5.0 版本就可以正常同步了.</p>\n<h3 id=\"同步报-syntax-error\"><a href=\"#同步报-syntax-error\" class=\"headerlink\" title=\"同步报 syntax error\"></a>同步报 <code>syntax error</code></h3><p>   可以将同步方式 修改为 <code>replicate-ds</code>试试看.</p>\n","feature":true,"text":"redis 迁移全量迁移 全量迁移比较简单,可以采用以下两种方式进行迁移. 1 rdb 导入导出 2 scan keys 进行同步 以上方式可以通过 redis-shake实现. 使用比较简单,可以参考官方文档进行配置. 增量迁移 增量迁移可以通过以下方式进行 1 通过PSYNC...","link":"","photos":[],"count_time":{"symbolsCount":"2.7k","symbolsTime":"2 mins."},"categories":[{"name":"redis","slug":"redis","count":1,"path":"api/categories/redis.json"}],"tags":[{"name":"redis","slug":"redis","count":1,"path":"api/tags/redis.json"},{"name":"腾讯云","slug":"腾讯云","count":1,"path":"api/tags/腾讯云.json"},{"name":"redis-shake","slug":"redis-shake","count":1,"path":"api/tags/redis-shake.json"},{"name":"riot-redis","slug":"riot-redis","count":1,"path":"api/tags/riot-redis.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#redis-%E8%BF%81%E7%A7%BB\"><span class=\"toc-text\">redis 迁移</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%85%A8%E9%87%8F%E8%BF%81%E7%A7%BB\"><span class=\"toc-text\">全量迁移</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%A2%9E%E9%87%8F%E8%BF%81%E7%A7%BB\"><span class=\"toc-text\">增量迁移</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#riot-redis-%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">riot-redis 介绍</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85-mac\"><span class=\"toc-text\">安装 - mac</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%91%BD%E4%BB%A4%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">命令介绍</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#replicate\"><span class=\"toc-text\">replicate</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%91%BD%E4%BB%A4%E7%A4%BA%E4%BE%8B\"><span class=\"toc-text\">命令示例</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%97%AE%E9%A2%98\"><span class=\"toc-text\">问题</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%BF%9E%E6%8E%A5-AWS-%E7%9A%84-redis-%E6%8A%A5-Client-set-AUTH-but-no-password-is-set\"><span class=\"toc-text\">连接 AWS 的 redis 报 Client set AUTH, but no password is set.</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%BF%9E%E6%8E%A5%E8%85%BE%E8%AE%AF%E4%BA%91-%E7%9A%84-redis-%E6%8A%A5-NOAUTH-Authentication-required\"><span class=\"toc-text\">连接腾讯云 的 redis 报  NOAUTH Authentication required.</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%90%8C%E6%AD%A5%E6%8A%A5-syntax-error\"><span class=\"toc-text\">同步报 syntax error</span></a></li></ol></li></ol></li></ol>","author":{"name":"tusimo","slug":"tusimo","avatar":"https://avatars.githubusercontent.com/u/4344635?v=4","link":"https://github.com/tusimo","description":"Think like an artist, code like an artisan.","socials":{"github":"https://tusimo.github.io","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"AWS DMS 迁移 mysql timestamp 字段时区不同步问题","uid":"b6f658d57561344b4e34417fd24455ba","slug":"AWS-DMS-迁移-mysql-timestamp-字段时区不同步问题","date":"2022-10-21T10:31:00.000Z","updated":"2022-10-21T11:13:16.031Z","comments":true,"path":"api/articles/AWS-DMS-迁移-mysql-timestamp-字段时区不同步问题.json","keywords":"coding","cover":[],"text":"问题线上服务 使用dms迁移到 aws ,在迁移数据库的时候遇到 timestamp 字段迁移出现时区不同步问题.在 dms 使用fullload全量 和cdc增量模式时.fullload全量 的时区正常.cdc增量模式时区相差 8 个小时. 调试我们源数据库在腾讯云上.mysq...","link":"","photos":[],"count_time":{"symbolsCount":"2.3k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"mysql","slug":"mysql","count":1,"path":"api/tags/mysql.json"},{"name":"dms","slug":"dms","count":1,"path":"api/tags/dms.json"},{"name":"cdc","slug":"cdc","count":1,"path":"api/tags/cdc.json"},{"name":"fulload","slug":"fulload","count":1,"path":"api/tags/fulload.json"},{"name":"timestamp","slug":"timestamp","count":1,"path":"api/tags/timestamp.json"},{"name":"timezone","slug":"timezone","count":1,"path":"api/tags/timezone.json"},{"name":"时区","slug":"时区","count":1,"path":"api/tags/时区.json"}],"author":{"name":"tusimo","slug":"tusimo","avatar":"https://avatars.githubusercontent.com/u/4344635?v=4","link":"https://github.com/tusimo","description":"Think like an artist, code like an artisan.","socials":{"github":"https://tusimo.github.io","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"高峰时期上线 HPA 引起的副本抖动","uid":"7217aeb6d9a4e768dbd053e0d0297223","slug":"高峰时期上线-HPA-引起的副本抖动","date":"2022-08-11T13:11:00.000Z","updated":"2022-10-21T11:13:16.035Z","comments":true,"path":"api/articles/高峰时期上线-HPA-引起的副本抖动.json","keywords":"coding","cover":[],"text":"现象我们在引入kubernetes的hpa功能后,高峰时期上线我们的pod副本数会缩小到replicas指定的数量后,然后hpa又会开始扩容,这个时候我们的pod无法支撑请求数,会出现大量的超时.等到hpa扩容后会恢复,导致高峰时期不敢轻易上线. 原因没有hpa之前,我们的副本数...","link":"","photos":[],"count_time":{"symbolsCount":"2.2k","symbolsTime":"2 mins."},"categories":[{"name":"kubernetes","slug":"kubernetes","count":2,"path":"api/categories/kubernetes.json"}],"tags":[{"name":"kubernetes","slug":"kubernetes","count":2,"path":"api/tags/kubernetes.json"},{"name":"hpa","slug":"hpa","count":1,"path":"api/tags/hpa.json"},{"name":"pod","slug":"pod","count":1,"path":"api/tags/pod.json"}],"author":{"name":"tusimo","slug":"tusimo","avatar":"https://avatars.githubusercontent.com/u/4344635?v=4","link":"https://github.com/tusimo","description":"Think like an artist, code like an artisan.","socials":{"github":"https://tusimo.github.io","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}