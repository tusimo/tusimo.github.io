{"title":"php 容器化的几点建议","uid":"b14c7bb0c256981c822f52d59e144945","slug":"php-容器化的几点建议","date":"2022-08-10T10:15:00.000Z","updated":"2024-09-23T08:16:39.379Z","comments":true,"path":"api/articles/php-容器化的几点建议.json","keywords":"coding","cover":"https://images.pexels.com/photos/1044990/pexels-photo-1044990.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1","content":"<h1 id=\"镜像编译\"><a href=\"#镜像编译\" class=\"headerlink\" title=\"镜像编译\"></a>镜像编译</h1><h2 id=\"基础镜像编译\"><a href=\"#基础镜像编译\" class=\"headerlink\" title=\"基础镜像编译\"></a>基础镜像编译</h2><p><a href=\"https://github.com/tusimo/docker-php-fpm\">github repo</a></p>\n<p>基础镜像编译使用环境变量替换配置.</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> php:<span class=\"number\">7.2</span>-fpm-alpine</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># replace repositories</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> sed -i <span class=\"string\">&#x27;s/dl-cdn.alpinelinux.org/mirrors.cloud.tencent.com/g&#x27;</span> /etc/apk/repositories</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># add timezone</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> apk add -u --no-cache tzdata \\</span></span><br><span class=\"line\"><span class=\"language-bash\"> &amp;&amp; <span class=\"built_in\">cp</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> apk upgrade &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    apk add --no-cache curl \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        boost-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        git \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        ca-certificates \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        automake \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        libtool \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        file \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        linux-headers \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        re2c \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        pkgconf \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        openssl-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        curl-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        autoconf \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        openssl \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        gcc \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        make \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        g++ \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        zlib-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        graphviz \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        libpng-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        libpq \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        icu-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        libffi-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        freetype-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        libxslt-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        libjpeg-turbo-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        libwebp-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        libmemcached-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        libmcrypt-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        libzip-dev \\</span></span><br><span class=\"line\"><span class=\"language-bash\">        librdkafka-dev &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    docker-php-ext-configure gd \\</span></span><br><span class=\"line\"><span class=\"language-bash\">      --with-gd \\</span></span><br><span class=\"line\"><span class=\"language-bash\">      --with-freetype-dir=/usr/include/ \\</span></span><br><span class=\"line\"><span class=\"language-bash\">      --with-png-dir=/usr/include/ \\</span></span><br><span class=\"line\"><span class=\"language-bash\">      --with-jpeg-dir=/usr/include/ \\</span></span><br><span class=\"line\"><span class=\"language-bash\">      --with-webp-dir=/usr/include/ &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    docker-php-ext-install fileinfo pdo_mysql mysqli gd exif intl xsl soap zip opcache sockets bcmath pcntl &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    docker-php-source delete</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> pecl install redis-5.0.2 memcached-3.1.4 rdkafka yaf-3.0.8 yar-2.0.5 mcrypt hprose-1.6.8 \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    &amp;&amp; docker-php-ext-enable redis memcached rdkafka yaf yar mcrypt hprose</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> wget https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.1.0.tar.gz -O /tmp/libwebp-1.1.0.tar.gz \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    &amp;&amp; tar -C /tmp -zxvf /tmp/libwebp-1.1.0.tar.gz \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    &amp;&amp; <span class=\"built_in\">cd</span> /tmp/libwebp-1.1.0 \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    &amp;&amp; ./configure --prefix=/usr/local/libwebp --enable-everything \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    &amp;&amp; make &amp;&amp; make install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> apk del autoconf gcc make g++ \\</span></span><br><span class=\"line\"><span class=\"language-bash\">    &amp;&amp; <span class=\"built_in\">rm</span> -fr /var/cache/apk/* /tmp/* /usr/share/man</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /var/www/html</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># use env control php and php-fpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> TZ=Asia/Shanghai</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> APP_ENV=product</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_DATE_TIMEZONE=<span class=\"string\">&quot;Asia/Shanghai&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_ERROR_LOG=<span class=\"string\">&quot;/proc/self/fd/2&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_LOG_LEVEL=<span class=\"string\">&quot;notice&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_PROCESS_MAX=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_RLIMIT_FILES=<span class=\"number\">51200</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_RLIMIT_CORE=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_USER=www-data</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_GROUP=www-data</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_LISTEN=<span class=\"number\">0.0</span>.<span class=\"number\">0.0</span>:<span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_PM=static</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_PM_MAX_CHILDREN=<span class=\"number\">20</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_PM_START_SERVERS=<span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_PM_MIN_SPARE_SERVERS=<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_PM_MAX_SPARE_SERVERS=<span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_PM_PROCESS_IDLE_TIMEOUT=<span class=\"number\">10</span>s</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_PM_MAX_REQUESTS=<span class=\"number\">10000</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_SLOWLOG=<span class=\"string\">&quot;/proc/self/fd/2&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_REQUEST_SLOWLOG_TIMEOUT=<span class=\"string\">&quot;2s&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_REQUEST_TERMINATE_TIMEOUT=<span class=\"string\">&quot;120s&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_MAX_EXECUTION_TIME=<span class=\"number\">600</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_MAX_INPUT_TIME=<span class=\"number\">60</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_MEMORY_LIMIT=<span class=\"number\">384</span>M</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_ERROR_REPORTING=<span class=\"string\">&quot;E_ALL &amp; ~E_DEPRECATED &amp; ~E_STRICT&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_DISPLAY_ERRORS=<span class=\"string\">&quot;Off&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_DISPLAY_STARTUP_ERRORS=<span class=\"string\">&quot;Off&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_POST_MAX_SIZE=<span class=\"number\">100</span>M</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_UPLOAD_MAX_FILESIZE=<span class=\"number\">50</span>M</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_MAX_FILE_UPLOADS=<span class=\"number\">20</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_ACCESS_LOG=<span class=\"string\">&quot;/dev/null&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_TRACK_ERRORS=Off</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_ACCESS_FORMAT=<span class=\"string\">&quot;&#123; \\&quot;type\\&quot;: \\&quot;access\\&quot;, \\&quot;time\\&quot;: \\&quot;%t\\&quot;, \\&quot;environment\\&quot;: \\&quot;%&#123;APP_ENV&#125;e\\&quot;, \\&quot;method\\&quot;: \\&quot;%m\\&quot;, \\&quot;request_uri\\&quot;: \\&quot;%r%Q%q\\&quot;, \\&quot;status_code\\&quot;: \\&quot;%s\\&quot;, \\&quot;cost_time\\&quot;: %&#123;mili&#125;d, \\&quot;cpu_usage\\&quot;: &#123; \\&quot;user\\&quot; : %&#123;user&#125;C, \\&quot;system\\&quot;: %&#123;system&#125;C, \\&quot;total\\&quot;: %&#123;total&#125;C &#125;, \\&quot;memory_usage\\&quot;: %&#123;bytes&#125;M, \\&quot;remote_ip\\&quot;: \\&quot;%R\\&quot;, \\&quot;module\\&quot;: \\&quot;php-fpm\\&quot;, \\&quot;log_type\\&quot;: \\&quot;access-log\\&quot; &#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_YAF_USE_NAMESPACE=Off</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_YAF_USE_SPL_AUTOLOAD=On</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_YAR_CONNECT_TIMEOUT=<span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_YAR_TIMEOUT=<span class=\"number\">5000</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_YAR_DEBUG=off</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_OPCACHE_ENABLE=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_OPCACHE_ENABLE_CLI=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_OPCACHE_MEMORY_CONSUMPTION=<span class=\"number\">128</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_OPCACHE_INTERNED_STRINGS_BUFFER=<span class=\"number\">8</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_OPCACHE_MAX_ACCELERATED_FILES=<span class=\"number\">100000</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_OPCACHE_MAX_WASTED_PERCENTAGE=<span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_OPCACHE_USE_CWD=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_OPCACHE_VALIDATE_TIMESTAMPS=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_OPCACHE_REVALIDATE_FREQ=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_OPCACHE_FAST_SHUTDOWN=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_OPCACHE_CONSISTENCY_CHECKS=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PHP_OPCACHE_BLACKLIST_FILENAME=/var/www/html/.opcacheignore</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> php-config/php.ini <span class=\"string\">&quot;<span class=\"variable\">$PHP_INI_DIR</span>&quot;</span></span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> php-config/conf.d/ <span class=\"string\">&quot;<span class=\"variable\">$PHP_INI_DIR</span>&quot;</span>/conf.d/</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> php-config/php-fpm.conf /usr/local/etc/</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> php-config/www.conf /usr/local/etc/php-fpm.d/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">9000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> <span class=\"built_in\">rm</span> -fr /usr/local/etc/php-fpm.d/zz-docker.conf</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> docker-entrypoint.sh /usr/local/bin/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"language-bash\"> [<span class=\"string\">&quot;docker-entrypoint.sh&quot;</span>]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;php-fpm&quot;</span>]</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>通过环境变量控制程序的行为.替换 php 的配置为 <code>$&#123;XXX&#125;</code>, 然后在<code>Dockerfile</code>中设置该环境变量.后续容器在运行时,可以通过改变环境变量来修改运行时的配置.</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class=\"line\"><span class=\"comment\">; FPM Configuration ;</span></span><br><span class=\"line\"><span class=\"comment\">;;;;;;;;;;;;;;;;;;;;;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; All relative paths in this configuration file are relative to PHP&#x27;s install</span></span><br><span class=\"line\"><span class=\"comment\">; prefix (/usr/local). This prefix can be dynamically changed by using the</span></span><br><span class=\"line\"><span class=\"comment\">; &#x27;-p&#x27; argument from the command line.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">;;;;;;;;;;;;;;;;;;</span></span><br><span class=\"line\"><span class=\"comment\">; Global Options ;</span></span><br><span class=\"line\"><span class=\"comment\">;;;;;;;;;;;;;;;;;;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[global]</span></span><br><span class=\"line\"><span class=\"comment\">; Pid file</span></span><br><span class=\"line\"><span class=\"comment\">; <span class=\"doctag\">Note:</span> the default prefix is /usr/local/var</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: none</span></span><br><span class=\"line\"><span class=\"comment\">;pid = run/php-fpm.pid</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; Error log file</span></span><br><span class=\"line\"><span class=\"comment\">; If it&#x27;s set to &quot;syslog&quot;, log is sent to syslogd instead of being written</span></span><br><span class=\"line\"><span class=\"comment\">; into a local file.</span></span><br><span class=\"line\"><span class=\"comment\">; <span class=\"doctag\">Note:</span> the default prefix is /usr/local/var</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: log/php-fpm.log</span></span><br><span class=\"line\"><span class=\"attr\">error_log</span> = <span class=\"variable\">$&#123;PHP_ERROR_LOG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; syslog_facility is used to specify what type of program is logging the</span></span><br><span class=\"line\"><span class=\"comment\">; message. This lets syslogd specify that messages from different facilities</span></span><br><span class=\"line\"><span class=\"comment\">; will be handled differently.</span></span><br><span class=\"line\"><span class=\"comment\">; See syslog(3) for possible values (ex daemon equiv LOG_DAEMON)</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: daemon</span></span><br><span class=\"line\"><span class=\"comment\">;syslog.facility = daemon</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; syslog_ident is prepended to every message. If you have multiple FPM</span></span><br><span class=\"line\"><span class=\"comment\">; instances running on the same server, you can change the default value</span></span><br><span class=\"line\"><span class=\"comment\">; which must suit common needs.</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: php-fpm</span></span><br><span class=\"line\"><span class=\"comment\">;syslog.ident = php-fpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; Log level</span></span><br><span class=\"line\"><span class=\"comment\">; Possible Values: alert, error, warning, notice, debug</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: notice</span></span><br><span class=\"line\"><span class=\"attr\">log_level</span> = <span class=\"variable\">$&#123;PHP_LOG_LEVEL&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; Log buffering specifies if the log line is buffered which means that the</span></span><br><span class=\"line\"><span class=\"comment\">; line is written in a single write operation. If the value is false, then the</span></span><br><span class=\"line\"><span class=\"comment\">; data is written directly into the file descriptor. It is an experimental</span></span><br><span class=\"line\"><span class=\"comment\">; option that can potentionaly improve logging performance and memory usage</span></span><br><span class=\"line\"><span class=\"comment\">; for some heavy logging scenarios. This option is ignored if logging to syslog</span></span><br><span class=\"line\"><span class=\"comment\">; as it has to be always buffered.</span></span><br><span class=\"line\"><span class=\"comment\">; Default value: yes</span></span><br><span class=\"line\"><span class=\"comment\">;log_buffering = no</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; If this number of child processes exit with SIGSEGV or SIGBUS within the time</span></span><br><span class=\"line\"><span class=\"comment\">; interval set by emergency_restart_interval then FPM will restart. A value</span></span><br><span class=\"line\"><span class=\"comment\">; of &#x27;0&#x27; means &#x27;Off&#x27;.</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: 0</span></span><br><span class=\"line\"><span class=\"comment\">;emergency_restart_threshold = 0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; Interval of time used by emergency_restart_interval to determine when</span></span><br><span class=\"line\"><span class=\"comment\">; a graceful restart will be initiated.  This can be useful to work around</span></span><br><span class=\"line\"><span class=\"comment\">; accidental corruptions in an accelerator&#x27;s shared memory.</span></span><br><span class=\"line\"><span class=\"comment\">; Available Units: s(econds), m(inutes), h(ours), or d(ays)</span></span><br><span class=\"line\"><span class=\"comment\">; Default Unit: seconds</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: 0</span></span><br><span class=\"line\"><span class=\"comment\">;emergency_restart_interval = 0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; Time limit for child processes to wait for a reaction on signals from master.</span></span><br><span class=\"line\"><span class=\"comment\">; Available units: s(econds), m(inutes), h(ours), or d(ays)</span></span><br><span class=\"line\"><span class=\"comment\">; Default Unit: seconds</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: 0</span></span><br><span class=\"line\"><span class=\"comment\">;process_control_timeout = 0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; The maximum number of processes FPM will fork. This has been designed to control</span></span><br><span class=\"line\"><span class=\"comment\">; the global number of processes when using dynamic PM within a lot of pools.</span></span><br><span class=\"line\"><span class=\"comment\">; Use it with caution.</span></span><br><span class=\"line\"><span class=\"comment\">; <span class=\"doctag\">Note:</span> A value of 0 indicates no limit</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: 0</span></span><br><span class=\"line\"><span class=\"attr\">process.max</span> = <span class=\"variable\">$&#123;PHP_PROCESS_MAX&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; Specify the nice(2) priority to apply to the master process (only if set)</span></span><br><span class=\"line\"><span class=\"comment\">; The value can vary from -19 (highest priority) to 20 (lowest priority)</span></span><br><span class=\"line\"><span class=\"comment\">; <span class=\"doctag\">Note:</span> - It will only work if the FPM master process is launched as root</span></span><br><span class=\"line\"><span class=\"comment\">;       - The pool process will inherit the master process priority</span></span><br><span class=\"line\"><span class=\"comment\">;         unless specified otherwise</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: no set</span></span><br><span class=\"line\"><span class=\"comment\">; process.priority = -19</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; Send FPM to background. Set to &#x27;no&#x27; to keep FPM in foreground for debugging.</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: yes</span></span><br><span class=\"line\"><span class=\"attr\">daemonize</span> = <span class=\"literal\">no</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; Set open file descriptor rlimit for the master process.</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: system defined value</span></span><br><span class=\"line\"><span class=\"attr\">rlimit_files</span> = <span class=\"variable\">$&#123;PHP_RLIMIT_FILES&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; Set max core size rlimit for the master process.</span></span><br><span class=\"line\"><span class=\"comment\">; Possible Values: &#x27;unlimited&#x27; or an integer greater or equal to 0</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: system defined value</span></span><br><span class=\"line\"><span class=\"comment\">;rlimit_core = 0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; Specify the event mechanism FPM will use. The following is available:</span></span><br><span class=\"line\"><span class=\"comment\">; - select     (any POSIX os)</span></span><br><span class=\"line\"><span class=\"comment\">; - poll       (any POSIX os)</span></span><br><span class=\"line\"><span class=\"comment\">; - epoll      (linux &gt;= 2.5.44)</span></span><br><span class=\"line\"><span class=\"comment\">; - kqueue     (FreeBSD &gt;= 4.1, OpenBSD &gt;= 2.9, NetBSD &gt;= 2.0)</span></span><br><span class=\"line\"><span class=\"comment\">; - /dev/poll  (Solaris &gt;= 7)</span></span><br><span class=\"line\"><span class=\"comment\">; - port       (Solaris &gt;= 10)</span></span><br><span class=\"line\"><span class=\"comment\">; Default Value: not set (auto detection)</span></span><br><span class=\"line\"><span class=\"attr\">events.mechanism</span> = epoll</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; When FPM is built with systemd integration, specify the interval,</span></span><br><span class=\"line\"><span class=\"comment\">; in seconds, between health report notification to systemd.</span></span><br><span class=\"line\"><span class=\"comment\">; Set to 0 to disable.</span></span><br><span class=\"line\"><span class=\"comment\">; Available Units: s(econds), m(inutes), h(ours)</span></span><br><span class=\"line\"><span class=\"comment\">; Default Unit: seconds</span></span><br><span class=\"line\"><span class=\"comment\">; Default value: 10</span></span><br><span class=\"line\"><span class=\"comment\">;systemd_interval = 10</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">;;;;;;;;;;;;;;;;;;;;</span></span><br><span class=\"line\"><span class=\"comment\">; Pool Definitions ;</span></span><br><span class=\"line\"><span class=\"comment\">;;;;;;;;;;;;;;;;;;;;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; Multiple pools of child processes may be started with different listening</span></span><br><span class=\"line\"><span class=\"comment\">; ports and different management options.  The name of the pool will be</span></span><br><span class=\"line\"><span class=\"comment\">; used in logs and stats. There is no limitation on the number of pools which</span></span><br><span class=\"line\"><span class=\"comment\">; FPM can handle. Your system will tell you anyway :)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">; Include one or more files. If glob(3) exists, it is used to include a bunch of</span></span><br><span class=\"line\"><span class=\"comment\">; files from a glob(3) pattern. This directive can be used everywhere in the</span></span><br><span class=\"line\"><span class=\"comment\">; file.</span></span><br><span class=\"line\"><span class=\"comment\">; Relative path can also be used. They will be prefixed by:</span></span><br><span class=\"line\"><span class=\"comment\">;  - the global prefix if it&#x27;s been set (-p argument)</span></span><br><span class=\"line\"><span class=\"comment\">;  - /usr/local otherwise</span></span><br><span class=\"line\"><span class=\"attr\">include</span>=etc/php-fpm.d/*.conf</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"服务镜像编译\"><a href=\"#服务镜像编译\" class=\"headerlink\" title=\"服务镜像编译\"></a>服务镜像编译</h2><p>往往 <code>php-fpm</code> 一般和 <code>nginx</code>配合来提供服务,  由于 <code>php-fpm</code> 与 <code>nginx</code> 是通过 <code>cgi</code> 通信, 所以在编译镜像的时候就要考虑<code>nginx</code> 和 <code>php-fpm</code>是如何通信和部署的.在传统的方式下,一般通过在宿主机部署<code>nginx</code> 和 <code>php-fpm</code>两个程序并通过 <code>cgi</code>进行通信.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    server_name _;</span><br><span class=\"line\"></span><br><span class=\"line\">    listen      80 default_server;</span><br><span class=\"line\"></span><br><span class=\"line\">    root        /var/www/html;</span><br><span class=\"line\"></span><br><span class=\"line\">    index  index.php index.html index.htm;</span><br><span class=\"line\"></span><br><span class=\"line\">\tadd_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;</span><br><span class=\"line\">\tadd_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;*&#x27;;</span><br><span class=\"line\">\tadd_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;*&#x27;;</span><br><span class=\"line\">\tif ($request_method = &#x27;OPTIONS&#x27;) &#123;</span><br><span class=\"line\">\t\t\treturn 204;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlocation /nginx-status &#123;</span><br><span class=\"line\">        stub_status;</span><br><span class=\"line\"></span><br><span class=\"line\">        access_log off;</span><br><span class=\"line\">        allow 127.0.0.1;</span><br><span class=\"line\">        deny all;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlocation / &#123;</span><br><span class=\"line\">\t\ttry_files $uri $uri/ /index.php$is_args$args;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlocation = /favicon.ico &#123; access_log off; log_not_found off; &#125;</span><br><span class=\"line\">    location = /robots.txt  &#123; access_log off; log_not_found off; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlocation ~ \\.(jpg|jpeg|gif|png|css|js|ico|xml|swf)$ &#123;</span><br><span class=\"line\">\t\tetag           on;</span><br><span class=\"line\">\t\texpires        max;</span><br><span class=\"line\">\t\taccess_log     off;</span><br><span class=\"line\">\t\tlog_not_found  off;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tlocation ~ [^/]\\.php(/|$) &#123;</span><br><span class=\"line\">\t\ttry_files $uri =404;                      </span><br><span class=\"line\">\t\tinclude        fastcgi_params;                                     </span><br><span class=\"line\">\t\tfastcgi_index index.php;                                           </span><br><span class=\"line\">\t\tfastcgi_split_path_info ^(.+\\.php)(/.+)$;                          </span><br><span class=\"line\">\t\tfastcgi_pass   unix:/dev/shm/php-cgi.sock;                         </span><br><span class=\"line\">\t\tfastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlocation ~ /\\.(?!well-known).* &#123;</span><br><span class=\"line\">        deny all;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t# return 404 for all other php files not matching the front controller</span><br><span class=\"line\">    # this prevents access to other php files you don&#x27;t want to be accessible.</span><br><span class=\"line\">    location ~ \\.php$ &#123;</span><br><span class=\"line\">\t\treturn 404;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>以上是一个通过 <code>unix socket</code>进行通信的方式,该配置对应 <code>php-fpm</code> 的配置为: <code>listen: /dev/shm/php-cgi.sock</code>. 该方式需要<code>nginx</code>和 <code>php-fpm</code>在同一个机器上.</p>\n<p>以上是一个通过 <code>unix socket</code>进行通信的方式,该配置对应 <code>php-fpm</code> 的配置为: <code>listen: /dev/shm/php-cgi.sock</code>. 该方式需要<code>nginx</code>和 <code>php-fpm</code>在同一个机器上.</p>\n<p>我们也可以使用网络进行通信.设置 <code>fastcgi_pass</code> 为 <code>127.0.0.1:9000</code> 以及 <code>php-fpm</code> 的 <code>listen:0.0.0.0:9000</code>.通过网络的方式不需要<code>nginx</code>和 <code>php-fpm</code>在同一个机器上.</p>\n<h3 id=\"php业务代码编译\"><a href=\"#php业务代码编译\" class=\"headerlink\" title=\"php业务代码编译\"></a>php业务代码编译</h3><div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<ul>\n<li>使用分阶段构建,编译和运行分开,减少不必要的资源引入</li>\n<li><code>composer</code>只在编译阶段引入,运行时无需开启</li>\n<li>基础 <code>php-fpm</code>使用小体积镜像</li>\n</ul>\n\n</div>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ARG</span> BASE_TAG</span><br><span class=\"line\"><span class=\"comment\"># First stage: build the executable.</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> composer AS builder</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Set the working directory outside $GOPATH to enable the support for modules.</span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /src</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Import the code from the context.</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> ./composer.json ./composer.lock /src/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> composer install --no-dev --prefer-dist --no-autoloader</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> ./ /src/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> composer dump-autoload -o &amp;&amp; composer clear-cache</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Final stage: the running container.</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> php-fpm  AS final</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Import the compiled executable from the first stage.</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> --from=builder /src /var/www/html</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /var/www/html</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">9000</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>下面的图代表了两种打包方式:</p>\n<h3 id=\"分开打包\"><a href=\"#分开打包\" class=\"headerlink\" title=\"分开打包\"></a>分开打包</h3><p>将<code>nginx</code>和<code>php-fpm</code>分别打包成两个镜像.</p>\n<p><img src=\"/images/pasted-5.png\" alt=\"upload successful\"></p>\n<h3 id=\"合并打包\"><a href=\"#合并打包\" class=\"headerlink\" title=\"合并打包\"></a>合并打包</h3><p>将<code>nginx</code>和<code>php-fpm</code>打包到同一个镜像,使用<code>supervisor</code>,<code>pm2</code>等进程管理工具管理进程.</p>\n<p><img src=\"/images/pasted-6.png\" alt=\"upload successful\"></p>\n<h1 id=\"镜像部署\"><a href=\"#镜像部署\" class=\"headerlink\" title=\"镜像部署\"></a>镜像部署</h1><p>目前流行的部署方式一般都是部署到<code>kubernetes</code>中,所以我们以<code>kubernetes</code>部署为例来分析下几种不同部署方式的优缺点.</p>\n<h2 id=\"nginx-和-php-fpm-单独部署\"><a href=\"#nginx-和-php-fpm-单独部署\" class=\"headerlink\" title=\"nginx 和 php-fpm 单独部署\"></a>nginx 和 php-fpm 单独部署</h2><p>将<code>nginx</code>和<code>php-fpm</code>部署成两个<code>deployments</code>,使用<code>service</code>进行通信.</p>\n<p><img src=\"/images/pasted-7.png\" alt=\"upload successful\"></p>\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">优点</p>\n<p><ul>\n<li><code>nginx</code>和<code>php-fpm</code>可以进行单独扩缩容</li>\n<li><code>nginx</code>和<code>php-fpm</code>可以进行单独配置和更新,不相互影响</li>\n<li><code>nginx</code>和<code>php-fpm</code>使用网络进行通信</li>\n<li>发布代码简单,只需要更新 <code>php-fpm</code> 的镜像即可</li>\n<li>比较灵活,节省资源</li>\n</ul>\n</p>\n</div>\n<div class=\"custom-quote warning\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 15.99V16.01\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">缺点</p>\n<ul>\n<li>部署比较麻烦,需要同时暴露<code>80</code>,<code>9000</code>端口</li>\n<li>容器的健康检查需要单独检查,无法针对业务接口设置健康检查</li>\n</ul>\n\n</div>\n<h2 id=\"nginx-和-php-fpm-部署到同一个-pod\"><a href=\"#nginx-和-php-fpm-部署到同一个-pod\" class=\"headerlink\" title=\"nginx 和 php-fpm 部署到同一个 pod\"></a>nginx 和 php-fpm 部署到同一个 pod</h2><p>部署一个<code>deployments</code>并使用两个 <code>container</code>部署到同一个<code>pod</code>里面.<br><img src=\"/images/pasted-8.png\" alt=\"upload successful\"></p>\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">优点</p>\n<p><ul>\n<li>无需暴露<code>php-fpm</code>的端口,内部容器通过共享网络栈通信</li>\n<li>部署相对简单,通过<code>pod</code>内部署多个<code>container</code>进行协作完成服务工作</li>\n</ul>\n</p>\n</div>\n<div class=\"custom-quote warning\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 15.99V16.01\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">缺点</p>\n<ul>\n<li>扩缩容需要一起,无法单独扩缩容</li>\n<li>相对浪费资源</li>\n</ul>\n\n</div>\n<h2 id=\"nginx-和-php-fpm-共同打包部署到一个-pod\"><a href=\"#nginx-和-php-fpm-共同打包部署到一个-pod\" class=\"headerlink\" title=\"nginx 和 php-fpm 共同打包部署到一个 pod\"></a>nginx 和 php-fpm 共同打包部署到一个 pod</h2><p><img src=\"/images/pasted-9.png\" alt=\"upload successful\"></p>\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">优点</p>\n<p><ul>\n<li><code>pod</code>内只有一个<code>container</code>,部署简单</li>\n<li>可以检查服务的健康</li>\n</ul>\n</p>\n</div>\n<div class=\"custom-quote warning\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 15.99V16.01\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">缺点</p>\n<ul>\n<li>扩缩容需要一起,无法单独扩缩容</li>\n<li>浪费资源</li>\n</ul>\n\n</div>\n<h1 id=\"程序运行\"><a href=\"#程序运行\" class=\"headerlink\" title=\"程序运行\"></a>程序运行</h1><h2 id=\"php-fpm-pm-管理配置\"><a href=\"#php-fpm-pm-管理配置\" class=\"headerlink\" title=\"php-fpm pm 管理配置\"></a>php-fpm pm 管理配置</h2><p>在<code>kubernetes</code>中一般会使用<code>hpa</code>根据资源的消耗进行自动扩缩容.如果选用<code>ondemand</code>,<code>dynamic</code>的方式,内存使用会存在波动,如果针对内存使用进行<code>hpa</code>往往来不及等到调度<br>成功并运行新的<code>pod</code>进行服务.在内存充足的情况下使用<code>static</code>的方式固定内存使用.<code>hpa</code>可以只根据<code>cpu</code>进行 hpa会更好.</p>\n<p><code>PHP_PM_MAX_CHILDREN</code> 并不是越大越好.我们可以开启<code>php-fpm</code>自带的<code>metrics</code>来观察 php-fpm的使用情况.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">; The URI to view the FPM status page. If this value is not set, no URI will be</span><br><span class=\"line\">; recognized as a status page. It shows the following informations:</span><br><span class=\"line\">;   pool                 - the name of the pool;</span><br><span class=\"line\">;   process manager      - static, dynamic or ondemand;</span><br><span class=\"line\">;   start time           - the date and time FPM has started;</span><br><span class=\"line\">;   start since          - number of seconds since FPM has started;</span><br><span class=\"line\">;   accepted conn        - the number of request accepted by the pool;</span><br><span class=\"line\">;   listen queue         - the number of request in the queue of pending</span><br><span class=\"line\">;                          connections (see backlog in listen(2));</span><br><span class=\"line\">;   max listen queue     - the maximum number of requests in the queue</span><br><span class=\"line\">;                          of pending connections since FPM has started;</span><br><span class=\"line\">;   listen queue len     - the size of the socket queue of pending connections;</span><br><span class=\"line\">;   idle processes       - the number of idle processes;</span><br><span class=\"line\">;   active processes     - the number of active processes;</span><br><span class=\"line\">;   total processes      - the number of idle + active processes;</span><br><span class=\"line\">;   max active processes - the maximum number of active processes since FPM</span><br><span class=\"line\">;                          has started;</span><br><span class=\"line\">;   max children reached - number of times, the process limit has been reached,</span><br><span class=\"line\">;                          when pm tries to start more children (works only for</span><br><span class=\"line\">;                          pm &#x27;dynamic&#x27; and &#x27;ondemand&#x27;);</span><br><span class=\"line\">; Value are updated in real time.</span><br><span class=\"line\">; Example output:</span><br><span class=\"line\">;   pool:                 www</span><br><span class=\"line\">;   process manager:      static</span><br><span class=\"line\">;   start time:           01/Jul/2011:17:53:49 +0200</span><br><span class=\"line\">;   start since:          62636</span><br><span class=\"line\">;   accepted conn:        190460</span><br><span class=\"line\">;   listen queue:         0</span><br><span class=\"line\">;   max listen queue:     1</span><br><span class=\"line\">;   listen queue len:     42</span><br><span class=\"line\">;   idle processes:       4</span><br><span class=\"line\">;   active processes:     11</span><br><span class=\"line\">;   total processes:      15</span><br><span class=\"line\">;   max active processes: 12</span><br><span class=\"line\">;   max children reached: 0</span><br><span class=\"line\">;</span><br><span class=\"line\">; By default the status page output is formatted as text/plain. Passing either</span><br><span class=\"line\">; &#x27;html&#x27;, &#x27;xml&#x27; or &#x27;json&#x27; in the query string will return the corresponding</span><br><span class=\"line\">; output syntax. Example:</span><br><span class=\"line\">;   http://www.foo.bar/status</span><br><span class=\"line\">;   http://www.foo.bar/status?json</span><br><span class=\"line\">;   http://www.foo.bar/status?html</span><br><span class=\"line\">;   http://www.foo.bar/status?xml</span><br><span class=\"line\">;</span><br><span class=\"line\">; By default the status page only outputs short status. Passing &#x27;full&#x27; in the</span><br><span class=\"line\">; query string will also return status for each pool process.</span><br><span class=\"line\">; Example:</span><br><span class=\"line\">;   http://www.foo.bar/status?full</span><br><span class=\"line\">;   http://www.foo.bar/status?json&amp;full</span><br><span class=\"line\">;   http://www.foo.bar/status?html&amp;full</span><br><span class=\"line\">;   http://www.foo.bar/status?xml&amp;full</span><br><span class=\"line\">; The Full status returns for each process:</span><br><span class=\"line\">;   pid                  - the PID of the process;</span><br><span class=\"line\">;   state                - the state of the process (Idle, Running, ...);</span><br><span class=\"line\">;   start time           - the date and time the process has started;</span><br><span class=\"line\">;   start since          - the number of seconds since the process has started;</span><br><span class=\"line\">;   requests             - the number of requests the process has served;</span><br><span class=\"line\">;   request duration     - the duration in µs of the requests;</span><br><span class=\"line\">;   request method       - the request method (GET, POST, ...);</span><br><span class=\"line\">;   request URI          - the request URI with the query string;</span><br><span class=\"line\">;   content length       - the content length of the request (only with POST);</span><br><span class=\"line\">;   user                 - the user (PHP_AUTH_USER) (or &#x27;-&#x27; if not set);</span><br><span class=\"line\">;   script               - the main script called (or &#x27;-&#x27; if not set);</span><br><span class=\"line\">;   last request cpu     - the %cpu the last request consumed</span><br><span class=\"line\">;                          it&#x27;s always 0 if the process is not in Idle state</span><br><span class=\"line\">;                          because CPU calculation is done when the request</span><br><span class=\"line\">;                          processing has terminated;</span><br><span class=\"line\">;   last request memory  - the max amount of memory the last request consumed</span><br><span class=\"line\">;                          it&#x27;s always 0 if the process is not in Idle state</span><br><span class=\"line\">;                          because memory calculation is done when the request</span><br><span class=\"line\">;                          processing has terminated;</span><br><span class=\"line\">; If the process is in Idle state, then informations are related to the</span><br><span class=\"line\">; last request the process has served. Otherwise informations are related to</span><br><span class=\"line\">; the current request being served.</span><br><span class=\"line\">; Example output:</span><br><span class=\"line\">;   ************************</span><br><span class=\"line\">;   pid:                  31330</span><br><span class=\"line\">;   state:                Running</span><br><span class=\"line\">;   start time:           01/Jul/2011:17:53:49 +0200</span><br><span class=\"line\">;   start since:          63087</span><br><span class=\"line\">;   requests:             12808</span><br><span class=\"line\">;   request duration:     1250261</span><br><span class=\"line\">;   request method:       GET</span><br><span class=\"line\">;   request URI:          /test_mem.php?N=10000</span><br><span class=\"line\">;   content length:       0</span><br><span class=\"line\">;   user:                 -</span><br><span class=\"line\">;   script:               /home/fat/web/docs/php/test_mem.php</span><br><span class=\"line\">;   last request cpu:     0.00</span><br><span class=\"line\">;   last request memory:  0</span><br><span class=\"line\">;</span><br><span class=\"line\">; Note: There is a real-time FPM status monitoring sample web page available</span><br><span class=\"line\">;       It&#x27;s available in: /usr/local/share/php/fpm/status.html</span><br><span class=\"line\">;</span><br><span class=\"line\">; Note: The value must start with a leading slash (/). The value can be</span><br><span class=\"line\">;       anything, but it may not be a good idea to use the .php extension or it</span><br><span class=\"line\">;       may conflict with a real PHP file.</span><br><span class=\"line\">; Default Value: not set</span><br><span class=\"line\">pm.status_path = /fpm-status</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>以上配置开启了监控.</p>\n<p>使用<a href=\"https://github.com/hipages/php-fpm_exporter\"><code>php-fpm-exporter</code></a>来暴露数据给<code>prometheus</code>拉取查看运行情况.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">使用 unix 通信 启动</span> </span><br><span class=\"line\">/usr/local/bin/php-fpm-exporter server --phpfpm.scrape-uri &quot;unix:///dev/shm/php-cgi.sock;/fpm-status&quot; --phpfpm.fix-process-count true</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">使用 tcp 通信 启动</span></span><br><span class=\"line\">/usr/local/bin/php-fpm-exporter server --phpfpm.scrape-uri &quot;tcp://127.0.0.1:9000/status&quot; --phpfpm.fix-process-count true</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>查看 <code>Running</code> <code>Idle</code> 数据.可以看到服务一般同时运行的数量,一般同时运行的数量都是比较少的.不足 <code>10</code> 个.</p>\n<p><img src=\"/images/pasted-10.png\" alt=\"upload successful\"></p>\n<p>如果响应比较慢就会发现同时运行的数量会攀升.部分慢接口会导致整个服务都会被拖垮.</p>\n<p><img src=\"/images/pasted-11.png\" alt=\"upload successful\"></p>\n<p>一般接口都要设置服务端的超时和客户端的超时控制.</p>\n<p>服务端可以通过<code>PHP_REQUEST_TERMINATE_TIMEOUT</code> 控制请求的执行时长.<br>客户端可以通过设置 <code>connect_timeout</code> <code>read_timeout</code> 等限制接口的执行时长.<br>避免慢接口堵塞请求导致服务大面积超时.</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">;;输出到控制台</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_ERROR_LOG</span>=<span class=\"string\">&quot;/proc/self/fd/2&quot;</span> </span><br><span class=\"line\">ENV <span class=\"attr\">PHP_RLIMIT_FILES</span>=<span class=\"number\">51200</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_RLIMIT_CORE</span>=<span class=\"number\">0</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_USER</span>=www-data</span><br><span class=\"line\">ENV <span class=\"attr\">PHP_GROUP</span>=www-data</span><br><span class=\"line\">ENV <span class=\"attr\">PHP_LISTEN</span>=<span class=\"number\">0.0</span>.<span class=\"number\">0.0</span>:<span class=\"number\">9000</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_PM</span>=static</span><br><span class=\"line\">ENV <span class=\"attr\">PHP_PM_MAX_CHILDREN</span>=<span class=\"number\">20</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_PM_START_SERVERS</span>=<span class=\"number\">4</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_PM_MIN_SPARE_SERVERS</span>=<span class=\"number\">2</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_PM_MAX_SPARE_SERVERS</span>=<span class=\"number\">10</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_PM_PROCESS_IDLE_TIMEOUT</span>=<span class=\"number\">10</span>s</span><br><span class=\"line\"><span class=\"comment\">;;请求超时 10000 次重启 fpm 进程</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_PM_MAX_REQUESTS</span>=<span class=\"number\">10000</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_SLOWLOG</span>=<span class=\"string\">&quot;/proc/self/fd/2&quot;</span></span><br><span class=\"line\"><span class=\"comment\">;;慢接口时长</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_REQUEST_SLOWLOG_TIMEOUT</span>=<span class=\"string\">&quot;2s&quot;</span></span><br><span class=\"line\"><span class=\"comment\">;;请求最大执行时长</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_REQUEST_TERMINATE_TIMEOUT</span>=<span class=\"string\">&quot;120s&quot;</span></span><br><span class=\"line\"><span class=\"comment\">;;cli 模式脚本最大执行时长</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_MAX_EXECUTION_TIME</span>=<span class=\"number\">600</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_MAX_INPUT_TIME</span>=<span class=\"number\">60</span></span><br><span class=\"line\"><span class=\"comment\">;; cli内存限制</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_MEMORY_LIMIT</span>=<span class=\"number\">384</span>M</span><br><span class=\"line\">ENV <span class=\"attr\">PHP_ERROR_REPORTING</span>=<span class=\"string\">&quot;E_ALL &amp; ~E_DEPRECATED &amp; ~E_STRICT&quot;</span></span><br><span class=\"line\"><span class=\"comment\">;;不输出日志</span></span><br><span class=\"line\">ENV <span class=\"attr\">PHP_ACCESS_LOG</span>=<span class=\"string\">&quot;/dev/null&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"高峰时期接口超时\"><a href=\"#高峰时期接口超时\" class=\"headerlink\" title=\"高峰时期接口超时\"></a>高峰时期接口超时</h2><p>1 查看<code>php-fpm</code>数量是否不够<br>2 <code>cpu</code>是否不够<br>3 查看 socket 连接是否不够</p>\n<p>之前我们系统迁移<code>kubernetes</code>低峰时期运行良好.高峰时期会阶段性的连接超时.<br>经过排查,发现是 socket 连接数不够用了.我们服务大多是短连接,占用较多的连接数.大量连接数在<code>TIME_WAIT</code>.<br>导致无可用<code>socket</code>来建立连接.出现接口大量超时.由于我们没有关注<code>connect_timeout</code>.排查起来非常困难.<br>后来使用<code>pod</code>里面的<code>init_container</code>来动态修改内核参数.一般修改网络相关的参数.<br>参考如下:</p>\n<p>有部分参数由于<code>腾讯云虚拟节点</code>的限制无法修改,所以只改了部分参数.<br>修改完之后我们连接超时的问题就消失了.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span></span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;start optimize&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">sysctl -w net.ipv4.tcp_max_syn_backlog=16384</span><br><span class=\"line\">sysctl -w net.ipv4.tcp_max_tw_buckets=32768</span><br><span class=\"line\">sysctl -w net.core.somaxconn=32768</span><br><span class=\"line\">sysctl -w net.ipv4.ip_local_port_range=&quot;10000 61000&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;optimize done&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"关于日志收集\"><a href=\"#关于日志收集\" class=\"headerlink\" title=\"关于日志收集\"></a>关于日志收集</h2><p>为了便于请求日式的收集,慢接口的日志收集.我们选择将所有的日志使用<code>json</code>的格式输出到控制台上.</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><code>php-fpm</code>的慢接口日志无法修改格式</p></blockquote>\n<p><code>kubernetes</code>会将所有容器的控制台日志保存在文件里.我们通过<code>daemonsets</code>在每个节点部署<code>filebeat</code>收集日志并发送到<code>elasticsearch</code>.</p>\n","text":"镜像编译基础镜像编译github repo 基础镜像编译使用环境变量替换配置. 1234567891011121314151617181920212223242...","permalink":"/post/php-容器化的几点建议","photos":[],"count_time":{"symbolsCount":"21k","symbolsTime":"19 mins."},"categories":[{"name":"kubernetes","slug":"kubernetes","count":2,"path":"api/categories/kubernetes.json"},{"name":"php","slug":"kubernetes/php","count":1,"path":"api/categories/kubernetes/php.json"}],"tags":[{"name":"php","slug":"php","count":1,"path":"api/tags/php.json"},{"name":"kubernetes","slug":"kubernetes","count":2,"path":"api/tags/kubernetes.json"},{"name":"nginx","slug":"nginx","count":1,"path":"api/tags/nginx.json"},{"name":"docker","slug":"docker","count":1,"path":"api/tags/docker.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E9%95%9C%E5%83%8F%E7%BC%96%E8%AF%91\"><span class=\"toc-text\">镜像编译</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F%E7%BC%96%E8%AF%91\"><span class=\"toc-text\">基础镜像编译</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%9C%8D%E5%8A%A1%E9%95%9C%E5%83%8F%E7%BC%96%E8%AF%91\"><span class=\"toc-text\">服务镜像编译</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#php%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E7%BC%96%E8%AF%91\"><span class=\"toc-text\">php业务代码编译</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%88%86%E5%BC%80%E6%89%93%E5%8C%85\"><span class=\"toc-text\">分开打包</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%90%88%E5%B9%B6%E6%89%93%E5%8C%85\"><span class=\"toc-text\">合并打包</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E9%95%9C%E5%83%8F%E9%83%A8%E7%BD%B2\"><span class=\"toc-text\">镜像部署</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#nginx-%E5%92%8C-php-fpm-%E5%8D%95%E7%8B%AC%E9%83%A8%E7%BD%B2\"><span class=\"toc-text\">nginx 和 php-fpm 单独部署</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#nginx-%E5%92%8C-php-fpm-%E9%83%A8%E7%BD%B2%E5%88%B0%E5%90%8C%E4%B8%80%E4%B8%AA-pod\"><span class=\"toc-text\">nginx 和 php-fpm 部署到同一个 pod</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#nginx-%E5%92%8C-php-fpm-%E5%85%B1%E5%90%8C%E6%89%93%E5%8C%85%E9%83%A8%E7%BD%B2%E5%88%B0%E4%B8%80%E4%B8%AA-pod\"><span class=\"toc-text\">nginx 和 php-fpm 共同打包部署到一个 pod</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C\"><span class=\"toc-text\">程序运行</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#php-fpm-pm-%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">php-fpm pm 管理配置</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%AB%98%E5%B3%B0%E6%97%B6%E6%9C%9F%E6%8E%A5%E5%8F%A3%E8%B6%85%E6%97%B6\"><span class=\"toc-text\">高峰时期接口超时</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%85%B3%E4%BA%8E%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86\"><span class=\"toc-text\">关于日志收集</span></a></li></ol></li></ol>","author":{"name":"tusimo","slug":"tusimo","avatar":"https://avatars.githubusercontent.com/u/4344635?v=4","link":"https://github.com/tusimo","description":"Think like an artist, code like an artisan.","socials":{"github":"https://tusimo.github.io","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"高峰时期上线 HPA 引起的副本抖动","uid":"7217aeb6d9a4e768dbd053e0d0297223","slug":"高峰时期上线-HPA-引起的副本抖动","date":"2022-08-11T13:11:00.000Z","updated":"2024-09-23T08:16:39.379Z","comments":true,"path":"api/articles/高峰时期上线-HPA-引起的副本抖动.json","keywords":"coding","cover":[],"text":"现象我们在引入kubernetes的hpa功能后,高峰时期上线我们的pod副本数会缩小到replicas指定的数量后,然后hpa又会开始扩容,这个时候我们的po...","permalink":"/post/高峰时期上线-HPA-引起的副本抖动","photos":[],"count_time":{"symbolsCount":"2.2k","symbolsTime":"2 mins."},"categories":[{"name":"kubernetes","slug":"kubernetes","count":2,"path":"api/categories/kubernetes.json"}],"tags":[{"name":"kubernetes","slug":"kubernetes","count":2,"path":"api/tags/kubernetes.json"},{"name":"hpa","slug":"hpa","count":1,"path":"api/tags/hpa.json"},{"name":"pod","slug":"pod","count":1,"path":"api/tags/pod.json"}],"author":{"name":"tusimo","slug":"tusimo","avatar":"https://avatars.githubusercontent.com/u/4344635?v=4","link":"https://github.com/tusimo","description":"Think like an artist, code like an artisan.","socials":{"github":"https://tusimo.github.io","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Istio 无法支持 HTTP1.0 和访问接口存在延迟的解决办法","uid":"8c86b39e74b792721702587f520ee80d","slug":"Istio无法支持-HTTP1-0-和访问接口存在延迟的解决办法","date":"2022-08-10T06:24:00.000Z","updated":"2024-09-23T08:16:39.378Z","comments":true,"path":"api/articles/Istio无法支持-HTTP1-0-和访问接口存在延迟的解决办法.json","keywords":"coding","cover":"http://www.designerspics.com/wp-content/uploads/2014/12/paper_plane_free_photo.jpg","text":"现象Rancher 通过 RKE 部署了 K8S 集群后,启动了 Istio,由于一些项目使用的事 HTTP/1.0协议,访问出现问题. Istio 默认只支持...","permalink":"/post/Istio无法支持-HTTP1-0-和访问接口存在延迟的解决办法","photos":[],"count_time":{"symbolsCount":"1.2k","symbolsTime":"1 mins."},"categories":[{"name":"Kubernetes","slug":"Kubernetes","count":1,"path":"api/categories/Kubernetes.json"}],"tags":[{"name":"RKE","slug":"RKE","count":1,"path":"api/tags/RKE.json"},{"name":"Rancher","slug":"Rancher","count":1,"path":"api/tags/Rancher.json"},{"name":"Istio","slug":"Istio","count":1,"path":"api/tags/Istio.json"},{"name":"HTTP","slug":"HTTP","count":1,"path":"api/tags/HTTP.json"},{"name":"Kubernetes","slug":"Kubernetes","count":1,"path":"api/tags/Kubernetes.json"},{"name":"Envoy","slug":"Envoy","count":1,"path":"api/tags/Envoy.json"}],"author":{"name":"tusimo","slug":"tusimo","avatar":"https://avatars.githubusercontent.com/u/4344635?v=4","link":"https://github.com/tusimo","description":"Think like an artist, code like an artisan.","socials":{"github":"https://tusimo.github.io","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}