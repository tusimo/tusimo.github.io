{"title":"Grafana 图表增加 Annotation 标记发布信息","uid":"f2bb7a23572ffaf10b751ed9095c199d","slug":"Grafana-图表增加-Annotation-标记发布信息","date":"2024-09-23T06:26:00.000Z","updated":"2024-09-23T07:24:49.343Z","comments":true,"path":"api/articles/Grafana-图表增加-Annotation-标记发布信息.json","keywords":"coding","cover":[],"content":"<h1 id=\"目的\"><a href=\"#目的\" class=\"headerlink\" title=\"目的\"></a>目的</h1><p> 对于已经绘制好的 <code>grafana</code> 的图表,我们在看到一些指标突然异常的时候,往往希望知道这个异常时间点到底发生了什么才导致指标异常的.这个时候排查可能会查看当时是否有功能上线发布. <code>grafana</code> 可以对图表增加 <code>annotation</code> 标记,天下一些有用的信息记录这个时间点发生的变化.可方便后续进行排查.</p>\n<p> 如图:</p>\n<p><img src=\"/images/pasted-15.png\" alt=\"upload successful\"></p>\n<p><img src=\"/images/pasted-16.png\" alt=\"upload successful\"></p>\n<h1 id=\"如何添加\"><a href=\"#如何添加\" class=\"headerlink\" title=\"如何添加\"></a>如何添加</h1><p><code>grafana</code> 可以通过接口进行添加 <code>annotation</code>,这对于自动化构建阶段可以很好的自动添加到 <code>grafana</code> 的面板.</p>\n<p>文档如下</p>\n<p><a href=\"https://grafana.com/docs/grafana/latest/developers/http_api/annotations/#create-annotation\">annotation  文档</a></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">POST &#x2F;api&#x2F;annotations HTTP&#x2F;1.1\nAccept: application&#x2F;json\nContent-Type: application&#x2F;json\n\n&#123;\n  &quot;dashboardUID&quot;:&quot;jcIIG-07z&quot;,\n  &quot;panelId&quot;:1,\n  &quot;time&quot;:1507037197339,\n  &quot;tags&quot;:[&quot;tag1&quot;,&quot;tag2&quot;],\n  &quot;text&quot;:&quot;Annotation Description&quot;\n&#125;\n\n# 其中 dashboardUID 可以不写,不写的话会在所有的图表上增加创建的&#96;annotation&#96;\n# panelId 也可以不写,填写会只在这个面板上渲染,其他的不会渲染.</code></pre>\n\n\n<h2 id=\"创建-service-account\"><a href=\"#创建-service-account\" class=\"headerlink\" title=\"创建 service account\"></a>创建 service account</h2><p>由于调用后台接口需要认证,需要先创建一个 <a href=\"https://grafana.com/docs/grafana/latest/administration/service-accounts/\"><code>service account</code> </a><br>使用生成的 <code>token</code> 调用后台接口进行创建 <code>annotation</code>.</p>\n<p>创建步骤如下:</p>\n<p><img src=\"/images/pasted-17.png\" alt=\"upload successful\"></p>\n<p><img src=\"/images/pasted-18.png\" alt=\"upload successful\"></p>\n<p><img src=\"/images/pasted-19.png\" alt=\"upload successful\"></p>\n<p><img src=\"/images/pasted-20.png\" alt=\"upload successful\"></p>\n<p>保存好上面创建的 <code>token</code>,后续调用接口需要使用.</p>\n<h2 id=\"gitlab-cicd-自动创建-Annotation\"><a href=\"#gitlab-cicd-自动创建-Annotation\" class=\"headerlink\" title=\"gitlab cicd 自动创建 Annotation\"></a>gitlab cicd 自动创建 Annotation</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">curl -vvv --location &#39;http:&#x2F;&#x2F;grafana.yourdomain.cn&#x2F;api&#x2F;annotations&#39; \\\n    --header &quot;Authorization: Bearer $GRAFANA_TOKEN&quot; \\\n    --header &#39;Content-Type: application&#x2F;json&#39; \\\n    --data &quot;&#123;\n        \\&quot;dashboardUID\\&quot;:\\&quot;$DASHBOARD_ID\\&quot;,\n        \\&quot;tags\\&quot;:[\n            \\&quot;namespace:$CI_PROJECT_NAMESPACE\\&quot;,\n            \\&quot;service:$CI_PROJECT_NAME\\&quot;,\n            \\&quot;author:$CI_COMMIT_AUTHOR\\&quot;,\n            \\&quot;commit:$CI_COMMIT_TITLE\\&quot;,\n            \\&quot;ref:$CI_COMMIT_REF_NAME\\&quot;,\n            \\&quot;job:$CI_JOB_ID\\&quot;,\n            \\&quot;env:$ENV\\&quot;\n        ],\n        \\&quot;text\\&quot;:\\&quot;$CI_COMMIT_AUTHOR: $CI_COMMIT_TITLE\\&quot;\n    &#125;&quot;\n</code></pre>\n\n<p>以上是使用 <code>curl</code> 调用接口自动创建<code>anotation</code> 的请求.<br>其中 <code>GRAFANA_TOKEN</code> 是之前创建 <code>service account</code> 的 <code>token</code>.</p>\n<p>该值是通过 gitlab 的 <code>CI/CD</code> 的 <code>Variables</code> 进行管理的.对于一些敏感的密钥 token 之类的可以通过该功能隐藏,不以明文的形式方式存储在代码里.</p>\n<p><img src=\"/images/pasted-21.png\" alt=\"upload successful\"></p>\n<p>同时 <code>gitlab</code> 在运行时也会把相关数据存储在运行时的变量里,我们可以获取到例如: 提交代码的 commit信息,提交的内容和作者等等.</p>\n<p>我们可以通过如下地址</p>\n<p><a href=\"https://docs.gitlab.com/ee/ci/variables/predefined_variables.html\">CI&#x2F;CD 预定义变量</a></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">...\nexport CI_SERVER_TLS_CA_FILE&#x3D;&quot;&#x2F;builds&#x2F;gitlab-examples&#x2F;ci-debug-trace.tmp&#x2F;CI_SERVER_TLS_CA_FILE&quot;\nif [[ -d &quot;&#x2F;builds&#x2F;gitlab-examples&#x2F;ci-debug-trace&#x2F;.git&quot; ]]; then\n  echo $&#39;\\&#39;&#39;\\x1b[32;1mFetching changes...\\x1b[0;m&#39;\\&#39;&#39;\n  $&#39;\\&#39;&#39;cd&#39;\\&#39;&#39; &quot;&#x2F;builds&#x2F;gitlab-examples&#x2F;ci-debug-trace&quot;\n  $&#39;\\&#39;&#39;git&#39;\\&#39;&#39; &quot;config&quot; &quot;fetch.recurseSubmodules&quot; &quot;false&quot;\n  $&#39;\\&#39;&#39;rm&#39;\\&#39;&#39; &quot;-f&quot; &quot;.git&#x2F;index.lock&quot;\n  $&#39;\\&#39;&#39;git&#39;\\&#39;&#39; &quot;clean&quot; &quot;-ffdx&quot;\n  $&#39;\\&#39;&#39;git&#39;\\&#39;&#39; &quot;reset&quot; &quot;--hard&quot;\n  $&#39;\\&#39;&#39;git&#39;\\&#39;&#39; &quot;remote&quot; &quot;set-url&quot; &quot;origin&quot; &quot;https:&#x2F;&#x2F;gitlab-ci-token:xxxxxxxxxxxxxxxxxxxx@example.com&#x2F;gitlab-examples&#x2F;ci-debug-trace.git&quot;\n  $&#39;\\&#39;&#39;git&#39;\\&#39;&#39; &quot;fetch&quot; &quot;origin&quot; &quot;--prune&quot; &quot;+refs&#x2F;heads&#x2F;*:refs&#x2F;remotes&#x2F;origin&#x2F;*&quot; &quot;+refs&#x2F;tags&#x2F;*:refs&#x2F;tags&#x2F;lds&quot;\n++ CI_BUILDS_DIR&#x3D;&#x2F;builds\n++ export CI_PROJECT_DIR&#x3D;&#x2F;builds&#x2F;gitlab-examples&#x2F;ci-debug-trace\n++ CI_PROJECT_DIR&#x3D;&#x2F;builds&#x2F;gitlab-examples&#x2F;ci-debug-trace\n++ export CI_CONCURRENT_ID&#x3D;87\n++ CI_CONCURRENT_ID&#x3D;87\n++ export CI_CONCURRENT_PROJECT_ID&#x3D;0\n++ CI_CONCURRENT_PROJECT_ID&#x3D;0\n++ export CI_SERVER&#x3D;yes\n++ CI_SERVER&#x3D;yes\n++ mkdir -p &#x2F;builds&#x2F;gitlab-examples&#x2F;ci-debug-trace.tmp\n++ echo -n &#39;-----BEGIN CERTIFICATE-----\n-----END CERTIFICATE-----&#39;\n++ export CI_SERVER_TLS_CA_FILE&#x3D;&#x2F;builds&#x2F;gitlab-examples&#x2F;ci-debug-trace.tmp&#x2F;CI_SERVER_TLS_CA_FILE\n++ CI_SERVER_TLS_CA_FILE&#x3D;&#x2F;builds&#x2F;gitlab-examples&#x2F;ci-debug-trace.tmp&#x2F;CI_SERVER_TLS_CA_FILE\n++ export CI_PIPELINE_ID&#x3D;52666\n++ CI_PIPELINE_ID&#x3D;52666\n++ export CI_PIPELINE_URL&#x3D;https:&#x2F;&#x2F;gitlab.com&#x2F;gitlab-examples&#x2F;ci-debug-trace&#x2F;pipelines&#x2F;52666\n++ CI_PIPELINE_URL&#x3D;https:&#x2F;&#x2F;gitlab.com&#x2F;gitlab-examples&#x2F;ci-debug-trace&#x2F;pipelines&#x2F;52666\n++ export CI_JOB_ID&#x3D;7046507\n++ CI_JOB_ID&#x3D;7046507\n++ export CI_JOB_URL&#x3D;https:&#x2F;&#x2F;gitlab.com&#x2F;gitlab-examples&#x2F;ci-debug-trace&#x2F;-&#x2F;jobs&#x2F;379424655\n++ CI_JOB_URL&#x3D;https:&#x2F;&#x2F;gitlab.com&#x2F;gitlab-examples&#x2F;ci-debug-trace&#x2F;-&#x2F;jobs&#x2F;379424655\n++ export CI_JOB_TOKEN&#x3D;[MASKED]\n++ CI_JOB_TOKEN&#x3D;[MASKED]\n++ export CI_REGISTRY_USER&#x3D;gitlab-ci-token\n++ CI_REGISTRY_USER&#x3D;gitlab-ci-token\n++ export CI_REGISTRY_PASSWORD&#x3D;[MASKED]\n++ CI_REGISTRY_PASSWORD&#x3D;[MASKED]\n++ export CI_REPOSITORY_URL&#x3D;https:&#x2F;&#x2F;gitlab-ci-token:[MASKED]@gitlab.com&#x2F;gitlab-examples&#x2F;ci-debug-trace.git\n++ CI_REPOSITORY_URL&#x3D;https:&#x2F;&#x2F;gitlab-ci-token:[MASKED]@gitlab.com&#x2F;gitlab-examples&#x2F;ci-debug-trace.git\n++ export CI_JOB_NAME&#x3D;debug_trace\n++ CI_JOB_NAME&#x3D;debug_trace\n++ export CI_JOB_STAGE&#x3D;test\n++ CI_JOB_STAGE&#x3D;test\n++ export CI_NODE_TOTAL&#x3D;1\n++ CI_NODE_TOTAL&#x3D;1\n++ export CI&#x3D;true\n++ CI&#x3D;true\n++ export GITLAB_CI&#x3D;true\n++ GITLAB_CI&#x3D;true\n++ export CI_SERVER_URL&#x3D;https:&#x2F;&#x2F;gitlab.com:3000\n++ CI_SERVER_URL&#x3D;https:&#x2F;&#x2F;gitlab.com:3000\n++ export CI_SERVER_HOST&#x3D;gitlab.com\n++ CI_SERVER_HOST&#x3D;gitlab.com\n++ export CI_SERVER_PORT&#x3D;3000\n++ CI_SERVER_PORT&#x3D;3000\n++ export CI_SERVER_SHELL_SSH_HOST&#x3D;gitlab.com\n++ CI_SERVER_SHELL_SSH_HOST&#x3D;gitlab.com\n++ export CI_SERVER_SHELL_SSH_PORT&#x3D;22\n++ CI_SERVER_SHELL_SSH_PORT&#x3D;22\n++ export CI_SERVER_PROTOCOL&#x3D;https\n++ CI_SERVER_PROTOCOL&#x3D;https\n++ export CI_SERVER_NAME&#x3D;GitLab\n++ CI_SERVER_NAME&#x3D;GitLab\n++ export GITLAB_FEATURES&#x3D;audit_events,burndown_charts,code_owners,contribution_analytics,description_diffs,elastic_search,group_bulk_edit,group_burndown_charts,group_webhooks,issuable_default_templates,issue_weights,jenkins_integration,ldap_group_sync,member_lock,merge_request_approvers,multiple_issue_assignees,multiple_ldap_servers,multiple_merge_request_assignees,protected_refs_for_users,push_rules,related_issues,repository_mirrors,repository_size_limit,scoped_issue_board,usage_quotas,wip_limits,adjourned_deletion_for_projects_and_groups,admin_audit_log,auditor_user,batch_comments,blocking_merge_requests,board_assignee_lists,board_milestone_lists,ci_cd_projects,cluster_deployments,code_analytics,code_owner_approval_required,commit_committer_check,cross_project_pipelines,custom_file_templates,custom_file_templates_for_namespace,custom_project_templates,custom_prometheus_metrics,cycle_analytics_for_groups,db_load_balancing,default_project_deletion_protection,dependency_proxy,deploy_board,design_management,email_additional_text,extended_audit_events,external_authorization_service_api_management,feature_flags,file_locks,geo,github_integration,group_allowed_email_domains,group_project_templates,group_saml,issues_analytics,jira_dev_panel_integration,ldap_group_sync_filter,merge_pipelines,merge_request_performance_metrics,merge_trains,metrics_reports,multiple_approval_rules,multiple_group_issue_boards,object_storage,operations_dashboard,packages,productivity_analytics,project_aliases,protected_environments,reject_unsigned_commits,required_ci_templates,scoped_labels,service_desk,smartcard_auth,group_timelogs,type_of_work_analytics,unprotection_restrictions,ci_project_subscriptions,container_scanning,dast,dependency_scanning,epics,group_ip_restriction,incident_management,insights,license_management,personal_access_token_expiration_policy,pod_logs,prometheus_alerts,report_approver_rules,sast,security_dashboard,tracing,web_ide_terminal\n++ GITLAB_FEATURES&#x3D;audit_events,burndown_charts,code_owners,contribution_analytics,description_diffs,elastic_search,group_bulk_edit,group_burndown_charts,group_webhooks,issuable_default_templates,issue_weights,jenkins_integration,ldap_group_sync,member_lock,merge_request_approvers,multiple_issue_assignees,multiple_ldap_servers,multiple_merge_request_assignees,protected_refs_for_users,push_rules,related_issues,repository_mirrors,repository_size_limit,scoped_issue_board,usage_quotas,wip_limits,adjourned_deletion_for_projects_and_groups,admin_audit_log,auditor_user,batch_comments,blocking_merge_requests,board_assignee_lists,board_milestone_lists,ci_cd_projects,cluster_deployments,code_analytics,code_owner_approval_required,commit_committer_check,cross_project_pipelines,custom_file_templates,custom_file_templates_for_namespace,custom_project_templates,custom_prometheus_metrics,cycle_analytics_for_groups,db_load_balancing,default_project_deletion_protection,dependency_proxy,deploy_board,design_management,email_additional_text,extended_audit_events,external_authorization_service_api_management,feature_flags,file_locks,geo,github_integration,group_allowed_email_domains,group_project_templates,group_saml,issues_analytics,jira_dev_panel_integration,ldap_group_sync_filter,merge_pipelines,merge_request_performance_metrics,merge_trains,metrics_reports,multiple_approval_rules,multiple_group_issue_boards,object_storage,operations_dashboard,packages,productivity_analytics,project_aliases,protected_environments,reject_unsigned_commits,required_ci_templates,scoped_labels,service_desk,smartcard_auth,group_timelogs,type_of_work_analytics,unprotection_restrictions,ci_project_subscriptions,cluster_health,container_scanning,dast,dependency_scanning,epics,group_ip_restriction,incident_management,insights,license_management,personal_access_token_expiration_policy,pod_logs,prometheus_alerts,report_approver_rules,sast,security_dashboard,tracing,web_ide_terminal\n++ export CI_PROJECT_ID&#x3D;17893\n++ CI_PROJECT_ID&#x3D;17893\n++ export CI_PROJECT_NAME&#x3D;ci-debug-trace\n++ CI_PROJECT_NAME&#x3D;ci-debug-trace\n...\n</code></pre>\n\n<h2 id=\"使用-gitlab-ci-yml-定义发布\"><a href=\"#使用-gitlab-ci-yml-定义发布\" class=\"headerlink\" title=\"使用 .gitlab-ci.yml 定义发布\"></a>使用 .gitlab-ci.yml 定义发布</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">stages:\n  - deploy\ndeploy-to-product:\n  stage: deploy\n  environment: product\n  only:\n    - master\n  script:\n    - curl -vvv --location &#39;http:&#x2F;&#x2F;grafana.yourdomain.cn&#x2F;api&#x2F;annotations&#39; \\\n    --header &quot;Authorization: Bearer $GRAFANA_TOKEN&quot; \\\n    --header &#39;Content-Type: application&#x2F;json&#39; \\\n    --data &quot;&#123;\n        \\&quot;dashboardUID\\&quot;:\\&quot;$DASHBOARD_ID\\&quot;,\n        \\&quot;tags\\&quot;:[\n            \\&quot;namespace:$CI_PROJECT_NAMESPACE\\&quot;,\n            \\&quot;service:$CI_PROJECT_NAME\\&quot;,\n            \\&quot;author:$CI_COMMIT_AUTHOR\\&quot;,\n            \\&quot;commit:$CI_COMMIT_TITLE\\&quot;,\n            \\&quot;ref:$CI_COMMIT_REF_NAME\\&quot;,\n            \\&quot;job:$CI_JOB_ID\\&quot;,\n            \\&quot;env:$ENV\\&quot;\n        ],\n        \\&quot;text\\&quot;:\\&quot;$CI_COMMIT_AUTHOR: $CI_COMMIT_TITLE\\&quot;\n    &#125;&quot;\n</code></pre>\n\n<p>当我们合并代码到<code>master</code> 分支后,就会自动打上响应的<code>annotation</code> .<br>这样就可以很方便的定位问题了.</p>\n","feature":true,"text":"目的 对于已经绘制好的 grafana 的图表,我们在看到一些指标突然异常的时候,往往希望知道这个异常时间点到底发生了什么才导致指标异常的.这个时候排查可能会查看当时是否有功能上线发布. grafana 可以对图表增加 annotation 标记,天下一些有用的信息记录这个时间点...","link":"","photos":[],"count_time":{"symbolsCount":"11k","symbolsTime":"10 mins."},"categories":[],"tags":[{"name":"grafana","slug":"grafana","count":1,"path":"api/tags/grafana.json"},{"name":"annotation","slug":"annotation","count":1,"path":"api/tags/annotation.json"},{"name":"gitlab","slug":"gitlab","count":1,"path":"api/tags/gitlab.json"},{"name":"ci/cd","slug":"ci-cd","count":1,"path":"api/tags/ci-cd.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%9B%AE%E7%9A%84\"><span class=\"toc-text\">目的</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0\"><span class=\"toc-text\">如何添加</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA-service-account\"><span class=\"toc-text\">创建 service account</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#gitlab-cicd-%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA-Annotation\"><span class=\"toc-text\">gitlab cicd 自动创建 Annotation</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8-gitlab-ci-yml-%E5%AE%9A%E4%B9%89%E5%8F%91%E5%B8%83\"><span class=\"toc-text\">使用 .gitlab-ci.yml 定义发布</span></a></li></ol></li></ol>","author":{"name":"tusimo","slug":"tusimo","avatar":"https://avatars.githubusercontent.com/u/4344635?v=4","link":"https://github.com/tusimo","description":"Think like an artist, code like an artisan.","socials":{"github":"https://tusimo.github.io","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{},"next_post":{"title":"AWS DMS 迁移 mysql timestamp 字段时区不同步问题","uid":"b6f658d57561344b4e34417fd24455ba","slug":"AWS-DMS-迁移-mysql-timestamp-字段时区不同步问题","date":"2022-10-21T10:31:00.000Z","updated":"2024-09-23T07:24:49.343Z","comments":true,"path":"api/articles/AWS-DMS-迁移-mysql-timestamp-字段时区不同步问题.json","keywords":"coding","cover":[],"text":"问题线上服务 使用dms迁移到 aws ,在迁移数据库的时候遇到 timestamp 字段迁移出现时区不同步问题.在 dms 使用fullload全量 和cdc增量模式时.fullload全量 的时区正常.cdc增量模式时区相差 8 个小时. 调试我们源数据库在腾讯云上.mysq...","link":"","photos":[],"count_time":{"symbolsCount":"2.3k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"mysql","slug":"mysql","count":1,"path":"api/tags/mysql.json"},{"name":"dms","slug":"dms","count":1,"path":"api/tags/dms.json"},{"name":"cdc","slug":"cdc","count":1,"path":"api/tags/cdc.json"},{"name":"fulload","slug":"fulload","count":1,"path":"api/tags/fulload.json"},{"name":"timestamp","slug":"timestamp","count":1,"path":"api/tags/timestamp.json"},{"name":"timezone","slug":"timezone","count":1,"path":"api/tags/timezone.json"},{"name":"时区","slug":"时区","count":1,"path":"api/tags/时区.json"}],"author":{"name":"tusimo","slug":"tusimo","avatar":"https://avatars.githubusercontent.com/u/4344635?v=4","link":"https://github.com/tusimo","description":"Think like an artist, code like an artisan.","socials":{"github":"https://tusimo.github.io","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}